[workspace]
channels = ["https://prefix.dev/conda-forge"]
platforms = ["linux-64", "osx-arm64", "osx-64"]
preview = ["pixi-build"]

# -------------------------------
# === Packaging Configuration ===
# -------------------------------
[package]
version = "dynamic"

[package.build]
backend = { name = "pixi-build-python", version = "*" }

[package.build.config]
noarch = false
compilers = ["c"]

[workspace.build-variants]
python = ["3.10.*", "3.11.*", "3.12.*"]

[package.host-dependencies]
uv = "*"
python = "*"
hatch-cython = ">=0.6.0"
hatch-vcs = "*"
numpy = "*"
cherab = "*"

[package.run-dependencies]
calcam = "*"
scipy = "*"
matplotlib-base = "*"
plotly = "*"
pooch = "*"
paramiko = "*"
tqdm = "*"
rich = "*"
cairosvg = "*"
xarray = "*"
netcdf4 = "*"
ffmpeg = "*"

# ---------------------------------
# === Development Configuration ===
# ---------------------------------
[dependencies]
cherab-nagdis = { path = "." }
ipython = "*"

# For JupyterLab and interactive plots
ipykernel = "*"
ipywidgets = "*"
jupyterlab = "*"
jupyter_bokeh = "*"
hvplot = "*"
panel = "*"
selenium = "*"
phantomjs = "*"
geckodriver = "*"
firefox = "*"
astroquery = ">=0.4.10,<0.5"
lmfit = ">=1.3.3,<2"

# For plotting publication quality figures
ultraplot = "*"

[pypi-dependencies]
wvfreader = "*"

[tasks]
dataset = { cmd = [
  "python",
  "-c",
  "'from experiment.dataset import create_dataset; create_dataset()'",
], description = "Create dataset for the experiment" }
ca = { cmd = "python scripts/ca.py", description = "Run Conditional & Moving Average of dataset" }
lab = { cmd = "jupyter lab --notebook-dir notebooks/", description = "ğŸš€ Launch Jupyter Lab" }

[activation.env]
SSH_RAYTRACE_HOSTNAME = "sftp://133.6.100.44/home/koyo/cherab/nagdis/"
SSH_RAYTRACE_USERNAME = "koyo"

# === Testing feature ===
[feature.tests.dependencies]
pytest = "*"
pytest-cov = "*"

[feature.tests.pypi-dependencies]
pytest-github-report = "*"

[feature.tests.tasks]
test = { cmd = ["pytest", "tests"], description = "ğŸ§ª Run the tests" }

# === Documentation feature ===
[feature.docs.dependencies]
ipykernel = "*"
ipywidgets = "*"
nbconvert = "*"
nbsphinx = "*"
numpydoc = "*"
pillow = "*"
pygments = ">2.11.0"
sphinx = "*"
sphinx-copybutton = "*"
pydata-sphinx-theme = "*"
sphinx-design = "*"
pandoc = "*"
sphinx-codeautolink = "*"
python-kaleido = "*"
myst-parser = "*"

[feature.docs.pypi-dependencies]
sphinx-github-style = "*"

[feature.docs.tasks]
doc-build = { cmd = [
  "sphinx-build",
  "-b",
  "{{ target }}",
  "source",
  "build/{{ target }}",
], cwd = "docs", args = [
  { arg = "target", default = "html" },
], description = "ğŸ“ Build the docs" }
doc-clean = { cmd = [
  "rm",
  "-rf",
  "build",
  "source/_api",
], cwd = "docs", description = "ğŸ”¥ Clean the docs build & api directory" }
doc-serve = { cmd = [
  "python",
  "-m",
  "http.server",
  "8000",
  "--directory",
  "build/html",
], cwd = "docs", description = "ğŸš€ Start a local server for the docs" }


# === Linting feature ===
[feature.lint.dependencies]
dprint = "*"
lefthook = "*"
ruff = "*"
typos = "*"
mypy = "*"
pyrefly = "*"
actionlint = "*"
shellcheck = "*"
validate-pyproject = "*"
cython-lint = "*"
blacken-docs = "*"
taplo = "*"

[feature.lint.tasks]
lefthook = { cmd = "lefthook", description = "ğŸ”— Run lefthook" }
hooks = { cmd = "lefthook install", description = "ğŸ”— Install pre-commit hooks" }
pre-commit = { cmd = "lefthook run pre-commit", description = "ğŸ”— Run pre-commit checks" }
mypy = { cmd = "mypy", description = "Type check with mypy" }
pyrefly-check = { cmd = "pyrefly check", description = "Type check with pyrefly" }
ruff-check = { cmd = "ruff check --fix", description = "Lint with ruff" }
ruff-format = { cmd = "ruff format", description = "Format with ruff" }
dprint = { cmd = "dprint fmt", description = "Format with dprint" }
typos = { cmd = "typos --write-changes --force-exclude", description = "Fix typos" }
taplo = { cmd = "taplo fmt", description = "Format toml files with taplo" }
actionlint = { cmd = "actionlint", description = "Lint actions with actionlint" }
blacken-docs = { cmd = "blacken-docs", description = "Format Python markdown blocks with Black" }
validate-pyproject = { cmd = "validate-pyproject pyproject.toml", description = "Validate pyproject.toml" }
cython-lint = { cmd = "cython-lint", description = "Lint Cython files" }
lint = { cmd = "lefthook run pre-commit --all-files --force", description = "ğŸ§¹ Run all linters" }

clean = { cmd = [
  "find",
  "src/",
  "-type",
  "f",
  "\\(",
  "-name",
  "'*.c'",
  "-o",
  "-name",
  "'*.so'",
  "-o",
  "-name",
  "'*.dylib'",
  "-o",
  "-name",
  "'*.html'",
  "\\)",
  "-delete",
], description = "ğŸ”¥ Remove build artifacts and temporary files (e.g. *.c, *.so, *.dylib, *.html)" }

# === Build feature ===
[feature.build.dependencies]
python-build = "*"

[feature.build.dev]
cherab-nagdis = { path = "." }

[feature.build.tasks]
build-wheel = { cmd = "python -m build -nx -w", description = "ğŸ”§ Build wheel distribution" }
build-sdist = { cmd = "python -m build -nx -s", description = "ğŸ”§ Build source distribution" }

# === Python Version Features ===
[feature.py310.dependencies]
python = "3.10.*"
[feature.py312.dependencies]
python = "3.12.*"

[environments]
default = { features = ["py312"], solve-group = "py312" }
docs = { features = ["py312", "docs"], solve-group = "py312" }
tests = { features = ["py312", "tests"], solve-group = "py312" }
tests-py312 = { features = [
  "py312",
  "tests",
], solve-group = "py312" } # alias of tests
tests-py310 = ["py310", "tests"]
lint = { features = ["lint"], no-default-feature = true }
build = { features = ["build"], no-default-feature = true }
