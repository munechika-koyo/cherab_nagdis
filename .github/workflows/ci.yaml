name: CI

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
  push:
    branches: [main]

jobs:
  lint:
    if: ${{ github.event_name == 'push' || !github.event.pull_request.draft }}
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: ğŸŸ¨ Set up Pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: v0.62.2
          environments: lint

      - name: ğŸ§¹ Execute lint
        run: pixi run -e lint lint

  checks:
    if: ${{ github.event_name == 'push' || !github.event.pull_request.draft }}
    name: Test ğŸ ${{ matrix.environment }} on ${{ startsWith(matrix.os, 'macos-') && 'macOS' || startsWith(matrix.os, 'windows-') && 'Windows' || 'Linux' }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        environment: [tests-py310, tests-py312]
    runs-on: ${{ matrix.os }}

    steps:
      - name: check out repo
        uses: actions/checkout@v4

      - name: ğŸŸ¨ Set up Pixi
        uses: prefix-dev/setup-pixi@v0.8.10
        with:
          environments: ${{ matrix.environment }}

      - name: ğŸ§ª Execute pytest
        env:
          pytest_github_report: true
        run: pixi run -e ${{ matrix.environment }} test --cov-report xml

      - name: ğŸ“¦ Disambiguate coverage filename by environment and OS
        run: mv .coverage ".coverage.${{ matrix.environment }}.${{ matrix.os }}.xml"

      - name: ğŸ“¤ Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
